name: Deploy home service

on:
    push:
        branches:
            - main

jobs:
    deploy:
        runs-on: self-hosted

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Use clean install + build with correct base
              run: |
                  npm ci
                  npm run build -- --base=/
              working-directory: ${{ github.workspace }}

            - name: Verify dist exists
              run: ls -la dist

            - name: Check built index.html uses / base
              run: |
                  grep -nE '(src="/assets|href="/assets)' dist/index.html && (echo "ERROR: still using /assets (wrong base)"; exit 1) || true
                  grep -nE '(src="/|href="/|base href="/")' dist/index.html || (echo "ERROR: missing /home/ in built index.html"; exit 1)

            - name: Deploy dist to Nginx web root
              run: |
                  mkdir -p /var/www/multimodal-home/html/
                  rm -rf /var/www/multimodal-home/html/*
                  cp -r dist/* /var/www/multimodal-home/html/

            - name: Reload Nginx
              run: sudo systemctl reload nginx
